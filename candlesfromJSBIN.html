<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Financial > Candlestick | Chart.js sample</title>
  <script src="http://www.chartjs.org/chartjs-chart-financial/moment.js" type="text/javascript"></script>
  <script src="http://www.chartjs.org/chartjs-chart-financial/Chart.js" type="text/javascript"></script>

  <!-- <script src="https://npmcdn.com/chart.js@latest/dist/Chart.bundle.min.js" type="text/javascript"></script> -->
  <script src="http://www.chartjs.org/chartjs-chart-financial/Chart.Financial.js" type="text/javascript"></script>
  <script src="http://www.chartjs.org/chartjs-chart-financial/utils.js" type="text/javascript"></script>

  <script src="https://hammerjs.github.io/dist/hammer.js" type="text/javascript"></script>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/0.6.3/chartjs-plugin-zoom.js" type="text/javascript"></script> -->

  <!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->


</head>

<body>

  <div class="content">
    <button onclick="add_data()">ADD DATA</button>
    <button onclick="set_quantity(20)">Set quantity 20</button>
    <button onclick="set_quantity(data.length)">Set quantity max</button>
    <h2>Candlestick</h2>
    <div style="width:1000px">
      <canvas id="chart1"></canvas>
    </div>
    <h2>Bar</h2>
    <div style="width:1000px">
      <canvas id="chart2"></canvas>
    </div>
  </div>

  <script>
    var tempdata1 = getRandomData('April 01 2017', 60);          //randomly generated data    ISN`T NEEDED IN PRODUCTION!
    var tempdata2 = [];                                          //data for bars + candles
    var data = [];                                               //data with filled empty days    THIS IS THE COMPLETE FORM OF DATA!


    //function for random data generation (part 2), ISN`T needed for production version
    tempdata1.forEach(function(element) {
      tempdata2.push({
        o: element.o,
        h: element.h,
        l: element.l,
        c: element.c,
        y: Math.random() * 15 + 10,
        t: element.t,
      });
    });


                //OPTIONS
    const interval = 86400000; //interval for one day in UNIX
    var color1 = '#060'; //green color    for bars background color
    var color2 = '#600'; //red color      for bars background color




    //filling emty days with rule - if day is empty, his o, h, l, c = previousobject.c, and y = 0
    for (i = 0; i < tempdata2.length - 1; i++) {
      data.push(tempdata2[i]);
      for (k = 0; k < (tempdata2[i + 1].t - tempdata2[i].t) / interval - 1; k++) { //in for - it`s quantity of "lost" time units without data
        let tempobject = {
          o: tempdata2[i].c,
          h: tempdata2[i].c,
          l: tempdata2[i].c,
          c: tempdata2[i].c,
          y: 0,
          t: tempdata2[i].t + (k + 1) * interval,
        };
        data.push(tempobject);
      }
    };
    data.push(tempdata2[tempdata2.length - 1]);


    var quantity = data.length; //default quantity of data to show. NOTE!!!!! function set_quantity saves the last set quantity in this variable
    var cutted_data = data.slice(); //data with quantity applied

    function set_quantity(quan) {
      cutted_data = [];
      for (i = Math.max(0, data.length - quan); i < data.length; i++) {
        cutted_data.push(data[i]);
      };
      chart1.data.datasets[0].data = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
        return {
          o: d.o,
          h: d.h,
          l: d.l,
          c: d.c,
          t: d.t,
        };
      });
      chart2.data.datasets[0].data = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
        return {
          y: d.y,
          t: d.t,
        };
      });
      chart1.data.datasets[0].backgroundColor = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
             return d.o < d.c ? color1 : color2;
      });
      chart2.data.datasets[0].backgroundColor = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
             return d.o < d.c ? color1 : color2;
      });
      quantity=quan;
      chart1.update();
      chart2.update();
    };



    custom_tick_func = function(value, index, values) {
      if (index % Math.round(quantity/20) == 0) return moment(cutted_data[index].t).format('D.M'); //show only every 4 tick on x-scale
    };


    function add_data() {
      cutted_data.push({
        o: Math.random() * 10 + 25,
        h: Math.random() * 10 + 25,
        l: Math.random() * 10 + 25,
        c: Math.random() * 10 + 25,
        y: Math.random() * 10 + 25,
        t: cutted_data[cutted_data.length - 1].t + interval,
      });
      cutted_data.shift();
      data.push(cutted_data[cutted_data.length-1]);
      chart1.data.datasets[0].data = cutted_data.map(function(d) {                   //set colors for bars (for candles - automaticly (built in chart type))
        return {
          o: d.o,
          h: d.h,
          l: d.l,
          c: d.c,
          t: d.t,
        };
      });
      chart2.data.datasets[0].data = cutted_data.map(function(d) {                   //set colors for bars (for candles - automaticly (built in chart type))
        return {
          y: d.y,
          t: d.t,
        };
      });
      chart1.data.datasets[0].backgroundColor = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
        return d.o < d.c ? color1 : color2;
      });
      chart2.data.datasets[0].backgroundColor = cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
        return d.o < d.c ? color1 : color2;
      });
      chart1.update();
      chart2.update();
    };



    // Candlestick
    var ctx = document.getElementById("chart1").getContext("2d");
    ctx.canvas.width = 2000;
    ctx.canvas.height = 500;
    var chart1 = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [{
          borderColor: '#000',
          backgroundColor: cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
            return d.o < d.c ? color1 : color2;
          }),
          label: "Candlezzz",
          data: cutted_data,
          fractionalDigitsCount: 8,
        }],
      },
      options: {
        tooltips: {
          enabled: true,
          intersect: false,
          position: 'nearest',
          mode: 'x',
          callbacks: {
            label: function(tooltipItems, data0) { //console logging of candles and bars data at the cursor x-index
              console.log({
                data: cutted_data[tooltipItems.index],
                tooltip_index: tooltipItems.index,
              });
            }
          },
          custom: function(tooltipModel) {
            tooltipModel.opacity = 0; //hide on-canvas tooltip
          }
        },
        scales: {
          xAxes: [{
            offset: true,
            type: 'time',
            display: true,
            distribution: 'linear',
            ticks: {
              maxRotation: 0,
              callback: function(value, index, values) {
                return (custom_tick_func(value, index, values));
              }
            },
          }],
          yAxes: [{
            position: 'right',
          }],
        },
        legend: {
          display: false,
        },
      },
    });


    var ctx0 = document.getElementById("chart2").getContext("2d");
    ctx0.canvas.width = 2000;
    ctx0.canvas.height = 500;
    var chart2 = new Chart(ctx0, {
      type: 'bar',
      data: {
        datasets: [{
          borderColor: '#000',
          borderWidth: 1,
          label: "Bar",
          backgroundColor: cutted_data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
            return d.o < d.c ? color1 : color2;
          }),
          data: cutted_data,
          fractionalDigitsCount: 8,
        }],
      },
      options: {
        tooltips: {
          enabled: true,
          intersect: false,
          mode: 'x',
          callbacks: {
            label: function(tooltipItems, data0) { //console logging of candle and bar under cursor (x-axis)
              console.log({
                data: cutted_data[tooltipItems.index],
                tooltip_index: tooltipItems.index,
              });
            }
          },
          custom: function(tooltipModel) {
            tooltipModel.opacity = 0; //hide on-canvas tooltip
          }
        },
        scales: {
          xAxes: [{
            type: 'time',
            display: true,
            offset: true,
            autoSkip: false,
            distribution: 'linear',
            gridLines: {
              offsetGridLines: false,
            },
            ticks: {
              maxRotation: 0,
              source: 'data',
              callback: function(value, index, values) {
                return custom_tick_func(value, index, values);
              }
            },
          }],
          yAxes: [{
            position: 'right',
          }],
        },
        legend: {
          display: false,
        },
      },
    });
  </script>
</body>

</html>
