<!DOCTYPE html>
<html lang="en-US">

<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>Financial > Candlestick | Chart.js sample</title>
   <script src="http://www.chartjs.org/chartjs-chart-financial/moment.js" type="text/javascript"></script>
   <script src="http://www.chartjs.org/chartjs-chart-financial/Chart.js" type="text/javascript"></script>

   <!-- <script src="https://npmcdn.com/chart.js@latest/dist/Chart.bundle.min.js" type="text/javascript"></script> -->
   <script src="http://www.chartjs.org/chartjs-chart-financial/Chart.Financial.js" type="text/javascript"></script>
   <script src="http://www.chartjs.org/chartjs-chart-financial/utils.js" type="text/javascript"></script>

   <script src="https://hammerjs.github.io/dist/hammer.js" type="text/javascript"></script>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/0.6.3/chartjs-plugin-zoom.js" type="text/javascript"></script>


   <link rel="stylesheet" type="text/css" href="../style.css">
   <link rel="icon" href="../favicon.ico" />



</head>

<body>

   <div class="content">
     <button onclick="add_data()">ADD DATA</button>
     <button onclick="set_quantity()">Set quantity 20</button>
      <h2>Candlestick</h2>
      <div style="width:1000px">
         <canvas id="chart1"></canvas>
      </div>
      <h2>Bar</h2>
      <div style="width:1000px">
         <canvas id="chart2"></canvas>
      </div>
   </div>

   <script>
      var tempdata1 = getRandomData('April 01 2017', 60);   //randomly generated data    ISN`T NEEDED IN PRODUCTION!
      var tempdata2 = [];                                   //data for bars + candles
      var cutted_data = [];                                 //data with quantity applied
      var data = [];                                        //data with filled empty days    THIS IS THE COMPLETE FORM OF DATA!


      //function for random data generation (part 2), ISN`T needed for production version
      tempdata1.forEach(function(element) {
         tempdata2.push({
           o:element.o,
           h:element.h,
           l:element.l,
           c:element.c,
           y:Math.random()*15+10,
           t:element.t,
         });
      });








            //OPTIONS
      const interval = 86400000;    //interval for one day in UNIX
      var quantity = 20;            //quantity of data to show
      var candle_tick_scale = 4;    //show every X tick on candles scale
      var bar_tick_scale = 2;       //show every X tick on bar scale
      data.w = 8;                   //width of candles and bars
      var color1 = '#060';          //green color    for bars background color
      var color2 = '#600';          //red color      for bars background color




      //filling emty days with rule - if day is empty, his o, h, l, c = previousobject.c, and y = 0
      for (i = 0; i < tempdata2.length - 1; i++) {
         data.push(tempdata2[i]);
         for (k = 0; k < (tempdata2[i + 1].t - tempdata2[i].t) / interval - 1; k++) { //in for - it`s quantity of "lost" time units without data
            let tempobject = {
               o: tempdata2[i].c,
               h: tempdata2[i].c,
               l: tempdata2[i].c,
               c: tempdata2[i].c,
               y:0,
               t: tempdata2[i].t + (k + 1) * interval,
            };
            data.push(tempobject);
         }
      };
      data.push(tempdata2[tempdata2.length - 1]);





      var datacolors = data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
         return d.o < d.c ? color1 : color2;
      });



      function set_quantity(){
        cutted_data = [];
        cutted_bardata = [];
        for(i=Math.max(0,data.length-quantity); i<data.length; i++){
          cutted_data.push(data[i]);
          cutted_bardata.push(bardata[i]);
        };
        chart1.data.datasets[0].data=cutted_data;
        chart2.data.datasets[0].data=cutted_bardata;
        chart2.update();
        chart1.update();
      };



      custom_candle_tick_func = function(value, index, values){
      if (true){if (index % candle_tick_scale == 0) return moment(data[index].t).format('D.M'); //show only every 4 tick on x-scale
      }
      else{
        if (index % custom_candle_tick_scale == 0) return moment(cutted_data[index].t).format('D.M');
      }
    };

    custom_bar_tick_func = function (value, index, values){
      if (true){if (index % bar_tick_scale == 0) return (moment(data[index * 2].t).format('D.M')); //show only every 4 tick on x-scale. NOTE!!!!!!!!!!!!!!!!!! indexes are going like this - 0 - 1 May, 1 - 3 May, 2 - 5 May
      }
      else{
        if (index % custom_bar_tick_scale == 0) return moment(data[index *2].t).format('D.M');
      }
    }


      function add_data() {
          data.push({
            o: Math.random()*20,
            h: Math.random()*20,
            l: Math.random()*20,
            c: Math.random()*20,
            t: data[data.length-1].t+interval,
          });
          data.shift();
          chart1.data.datasets[0].backgroundColor=data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
             // console.log(d.o < d.c);
             return d.o < d.c ? color1 : color2;
          });
          chart1.update();
          bardata.push({
            t: bardata[bardata.length-1].t+interval,
            y: Math.random()*20+10,
          });
          bardata.shift();
          chart2.data.datasets[0].backgroundColor=data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
             // console.log(d.o < d.c);
             return d.o < d.c ? color1 : color2;
          });
          chart2.update();
      };



      // Candlestick
      var ctx = document.getElementById("chart1").getContext("2d");
      ctx.canvas.width = 2000;
      ctx.canvas.height = 500;
      var chart1 = new Chart(ctx, {
         type: 'candlestick',
         data: {
            datasets: [{
               borderColor: '#000',
               backgroundColor: datacolors,
               label: "Candlezzz",
               data: data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
                  return {
                    o:d.o,
                    h:d.h,
                    l:d.l,
                    c:d.c,
                    t:d.t,
                  };
               }),
               fractionalDigitsCount: 8,
            }],
         },
         options: {
            tooltips: {
               enabled: true,
               intersect: false,
               position: 'nearest',
               mode: 'x',
               callbacks: {
                  label: function(tooltipItems, data0) { //console logging of candles and bars data at the cursor x-index
                    console.log({
                      data:data[tooltipItems.index],
                      tooltip_index:tooltipItems.index,
                    });
                  }
               },
               custom: function(tooltipModel) {
                  tooltipModel.opacity = 0;    //hide on-canvas tooltip
               }
            },
            scales: {
               xAxes: [{
                  barThickness: data.w,
                  offset: true,
                  type: 'time',
                  display: true,
                  distribution: 'linear',
                  ticks: {
                     maxRotation: 0,
                     callback: function(value, index, values) {
                        return (custom_candle_tick_func(value, index, values));
                     }
                  },
               }],
               yAxes: [{
                  position: 'right',
               }],
            },
            legend: {
               display: false,
            },
         },
      });


      var ctx0 = document.getElementById("chart2").getContext("2d");
      ctx0.canvas.width = 2000;
      ctx0.canvas.height = 500;
      var chart2 = new Chart(ctx0, {
         type: 'bar',
         data: {
            datasets: [{
               borderColor: '#000',
               borderWidth: 1,
               label: "Bar",
               backgroundColor: datacolors,
               data: data.map(function(d) { //set colors for bars (for candles - automaticly (built in chart type))
                  return {
                    y:d.y,
                    t:d.t,
                  };
               }),
               fractionalDigitsCount: 8,
            }],
         },
         options: {
            tooltips: {
               enabled: true,
               intersect: false,
               mode: 'x',
               callbacks: {
                  label: function(tooltipItems, data0) { //console logging of candle and bar under cursor (x-axis)
                     console.log({
                       data:data[tooltipItems.index],
                       tooltip_index:tooltipItems.index,
                     });
                  }
               },
               custom: function(tooltipModel) {
                  tooltipModel.opacity = 0;           //hide on-canvas tooltip
               }
            },
            scales: {
               xAxes: [{
                  type: 'time',
                  display: true,
                  offset: true,
                  distribution: 'linear',
                  barThickness: data.w,
                  categoryPercentage: 0.5,
                  gridLines: {
                     offsetGridLines: false,
                  },
                  ticks: {
                     maxRotation: 0,
                     callback: function(value, index, values) {
                        return custom_bar_tick_func (value, index, values);
                     }
                  },
               }],
               yAxes: [{
                  position: 'right',
               }],
            },
            legend: {
               display: false,
            },
         },
      });
   </script>
</body>
</html>
